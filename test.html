<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>parkrunner tourist</title>
    <link rel="shortcut icon" type="image/x.icon" href="favicon.ico?">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        #map {
            height: 100vh;
            width: 100vw;
        }
        .controls {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
            display: none; /* Hide the controls */
        }
        .hotel-btn, .course-btn, .volunteer-btn, .direction-btn {
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            text-align: center;
            text-decoration: none;
            box-sizing: border-box;
        }
        .hotel-btn {
            background-color: #6200ea;
        }
        .hotel-btn:hover {
            background-color: #4500b0;
        }
        
        .direction-btn {
            background-color: #d90b26;
        }
        .direction-btn:hover {
            background-color: #b71c1c;
        }
        
        .course-btn {
            background-color: #28a745;
        }
        .course-btn:hover {
            background-color: #218838;
        }
        .volunteer-btn {
            background-color: #e83e8c;
        }
        .volunteer-btn:hover {
            background-color: #d6336c;
        }
        .popup-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .leaflet-control-attribution {
            display: none;
        }
        #search-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            align-items: center;
        }
        #search-icon {
            font-size: 24px;
            color: #333;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        #search-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column; /* Stack items vertically */
            align-items: center;
        }
        #search-input-container {
            display: flex;
            align-items: center;
            margin-left: 0; /* Remove left margin */
        }
        #search-icon {
            font-size: 24px;
            color: #333;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        #search-input {
            width: 0;
            opacity: 0;
            transition: width 0.3s ease, opacity 0.3s ease;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #search-input.show {
            width: 40vw;
            max-width: 300px;
            opacity: 1;
        }
        #clear-btn {
            display: none;
            margin-left: 10px;
            background: none;
            border: none;
            cursor: pointer;
            color: #333;
            font-size: 16px;
        }
        #icon-container {
            display: flex;
            flex-direction: column; /* Stack icon vertically */
            align-items: center;
            margin-top: 10px; /* Space between search icon and new button */
        }
        #alphabet-btn {
            font-size: 24px;
            color: #333;
            cursor: pointer;
            transition: color 0.3s ease;
            background: none;
            border: none;
            padding: 10px;
        }
        #alphabet-btn:hover {
            color: #007bff;
        }
        #hotel-widget-container {
            position: absolute;
            top: 10%;
            left: 10%;
            right: 10%;
            bottom: 10%;
            z-index: 1000;
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
            overflow: auto;
            display: none;
        }
        #hotel-search-widget {
            height: 100%;
            width: 100%;
        }
        #close-hotel-widget {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1001;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #333;
        }
        
        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.5);
            z-index: 900;
            display: none;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="search-container">
        <i id="search-icon" class="fas fa-search"></i>
        <div id="search-input-container">
            <input type="text" id="search-input" placeholder="Search Parkrun">
            <button id="clear-btn"><i class="fas fa-times"></i></button>
        </div>
        <div id="icon-container">
            <button id="alphabet-btn" class="icon-btn">
                <i class="fa-solid fa-arrow-down-a-z"></i>
            </button>
        </div>
    </div>
    <div id="hotel-widget-container">
        <button id="close-hotel-widget">X</button>
        <div data-skyscanner-widget="HotelSearchWidget"
             data-locale="en-GB"
             data-market="UK"
             data-currency="GBP"
             data-hide-powered-by="true"
             data-button-colour="#58993D"
             data-web-only-redirects="true"
             id="hotel-search-widget"></div>
    </div>
    <div id="map-overlay" class="map-overlay"></div>
    
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://widgets.skyscanner.net/widget-server/js/loader.js" async></script>
    <script>
        function openUrl(url) {
            window.open(url, '_blank');
        }
        
        var map = L.map('map', {
            center: [51.505, -0.09],
            zoom: 13,
            zoomControl: false
        });

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 19
        }).addTo(map);

        var juniorIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/ALD-Models/pr-tourist-map/main/1.png',
            iconSize: [38, 38],
            iconAnchor: [19, 38],
            popupAnchor: [0, -38]
        });

        var fiveKIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/ALD-Models/pr-tourist-map/main/2.png',
            iconSize: [38, 38],
            iconAnchor: [19, 38],
            popupAnchor: [0, -38]
        });

        var markers = L.markerClusterGroup();
        var data = {};

        function updateMapMarkers() {
            markers.clearLayers();

            if (!data.events || !data.events.features) return;

            data.events.features.forEach(function (feature) {
                var coords = feature.geometry.coordinates;
                var latLng = L.latLng(coords[1], coords[0]);

                var eventId = feature.properties.eventname;
                var marker;

                if (eventId.toLowerCase().includes('juniors')) {
                    marker = L.marker(latLng, { icon: juniorIcon });
                } else {
                    marker = L.marker(latLng, { icon: fiveKIcon });
                }

                marker.bindPopup('<strong>' + feature.properties.eventname + '</strong><br>' +
                    feature.properties.eventlocation + '<br>' +
                    '<a href="https://www.parkrun.org.uk/' + feature.properties.eventname + '" target="_blank">Event Page</a>');

                markers.addLayer(marker);
            });

            map.addLayer(markers);
        }

        var xhr = new XMLHttpRequest();
        xhr.open("GET", "https://raw.githubusercontent.com/ALD-Models/pr-tourist-map/main/sites.geojson", true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                data = JSON.parse(xhr.responseText);
                updateMapMarkers();
            }
        };
        xhr.send();

        var searchIcon = document.getElementById('search-icon');
        var searchInput = document.getElementById('search-input');
        var clearBtn = document.getElementById('clear-btn');

        searchIcon.addEventListener('click', function () {
            if (!searchInput.classList.contains('show')) {
                searchInput.classList.add('show');
                searchInput.focus();
            } else {
                searchInput.classList.remove('show');
            }
        });

        searchInput.addEventListener('input', function () {
            var searchTerm = searchInput.value.toLowerCase();

            markers.clearLayers();

            data.events.features.forEach(function (feature) {
                var eventName = feature.properties.eventname.toLowerCase();
                var eventLocation = feature.properties.eventlocation.toLowerCase();

                if (eventName.includes(searchTerm) || eventLocation.includes(searchTerm)) {
                    var coords = feature.geometry.coordinates;
                    var latLng = L.latLng(coords[1], coords[0]);

                    var marker;
                    if (eventName.includes('juniors')) {
                        marker = L.marker(latLng, { icon: juniorIcon });
                    } else {
                        marker = L.marker(latLng, { icon: fiveKIcon });
                    }

                    marker.bindPopup('<strong>' + feature.properties.eventname + '</strong><br>' +
                        feature.properties.eventlocation + '<br>' +
                        '<a href="https://www.parkrun.org.uk/' + feature.properties.eventname + '" target="_blank">Event Page</a>');

                    markers.addLayer(marker);
                }
            });

            if (searchTerm === '') {
                clearBtn.style.display = 'none';
            } else {
                clearBtn.style.display = 'block';
            }

            map.addLayer(markers);
        });

        clearBtn.addEventListener('click', function () {
            searchInput.value = '';
            clearBtn.style.display = 'none';
            updateMapMarkers();
        });

        var alphabetBtn = document.getElementById('alphabet-btn');
        var alphabetSortAscending = true;

        alphabetBtn.addEventListener('click', function () {
            alphabetSortAscending = !alphabetSortAscending;
            sortMarkersByAlphabet(alphabetSortAscending);
        });

        function sortMarkersByAlphabet(ascending) {
            var features = data.events.features.slice();
            features.sort(function (a, b) {
                var nameA = a.properties.eventname.toLowerCase();
                var nameB = b.properties.eventname.toLowerCase();

                if (ascending) {
                    return nameA.localeCompare(nameB);
                } else {
                    return nameB.localeCompare(nameA);
                }
            });

            markers.clearLayers();

            features.forEach(function (feature) {
                var coords = feature.geometry.coordinates;
                var latLng = L.latLng(coords[1], coords[0]);

                var eventId = feature.properties.eventname;
                var marker;

                if (eventId.toLowerCase().includes('juniors')) {
                    marker = L.marker(latLng, { icon: juniorIcon });
                } else {
                    marker = L.marker(latLng, { icon: fiveKIcon });
                }

                marker.bindPopup('<strong>' + feature.properties.eventname + '</strong><br>' +
                    feature.properties.eventlocation + '<br>' +
                    '<a href="https://www.parkrun.org.uk/' + feature.properties.eventname + '" target="_blank">Event Page</a>');

                markers.addLayer(marker);
            });

            map.addLayer(markers);
        }

        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        var juniorParam = getUrlParameter('junior');
        var fiveKParam = getUrlParameter('fivek');

        function filterMarkers() {
            var showJuniors = juniorParam === 'true';
            var showFiveK = fiveKParam === 'true';

            markers.clearLayers();

            data.events.features.forEach(function (feature) {
                var eventName = feature.properties.eventname.toLowerCase();

                var coords = feature.geometry.coordinates;
                var latLng = L.latLng(coords[1], coords[0]);

                var marker;
                if (eventName.includes('juniors') && showJuniors) {
                    marker = L.marker(latLng, { icon: juniorIcon });
                } else if (!eventName.includes('juniors') && showFiveK) {
                    marker = L.marker(latLng, { icon: fiveKIcon });
                }

                if (marker) {
                    marker.bindPopup('<strong>' + feature.properties.eventname + '</strong><br>' +
                        feature.properties.eventlocation + '<br>' +
                        '<a href="https://www.parkrun.org.uk/' + feature.properties.eventname + '" target="_blank">Event Page</a>');
                    markers.addLayer(marker);
                }
            });

            map.addLayer(markers);
        }

        if (juniorParam || fiveKParam) {
            filterMarkers();
        } else {
            updateMapMarkers();
        }
    </script>
</body>
</html>
