<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Event Finder</title>
    
    <!-- Leaflet CSS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <!-- MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh; /* Full height */
            overflow: hidden; /* Prevent scrolling on body */
        }
        h1 {
            text-align: center;
            margin-top: 20px;
            color: #2c3e50;
        }
        .toggle-container {
            margin: 20px;
        }
        .toggle-container button {
            padding: 15px 30px; /* Increased padding */
            margin: 0 5px;
            font-size: 18px; /* Larger font size */
            border: none;
            border-radius: 8px; /* Rounded corners */
            background-color: #64af46; /* Theme color */
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); /* Subtle shadow */
        }
        .toggle-container button.active {
            background-color: #559d3b; /* Darker shade for active */
            font-weight: bold; /* Highlight active button */
        }
        .search-container {
            display: flex;
            justify-content: center;
            width: calc(100% - 40px); /* Full width minus padding */
            max-width: 600px;
            margin: 20px auto;
            flex-wrap: wrap;
            padding: 0 20px; /* Even padding on left and right */
        }
        .search-container input {
            width: calc(100% - 130px); /* Responsive width minus button width */
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-right: 10px;
            height: 40px; /* Consistent height for input */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        .search-container button {
            padding: 10px;
            background-color: #64af46; /* Theme color */
            color: #fff;
            border: none;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
            height: 40px; /* Consistent height for button */
        }
        .search-container button:hover {
            background-color: #559d3b; /* Darker shade for hover */
        }
        #map, #results {
            height: calc(100vh - 100px); /* Larger map height */
            width: 100vw; /* Full width of the viewport */
            margin: 0;
            padding: 0;
            border-radius: 0; /* Remove border-radius for full-screen feel */
            display: none; /* Start hidden, will be toggled */
        }
        #map.active, #results.active {
            display: block; /* Show when active */
        }
        .result-container {
            width: 100%;
            max-width: 600px;
            height: 200px;
            overflow-y: auto;
            margin: 20px auto;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .result-container div {
            margin-bottom: 10px;
            font-size: 16px;
            cursor: pointer;
            padding: 10px;
            background-color: #ecf0f1;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .result-container div:hover {
            background-color: #bdc3c7;
        }
        
        /* Notification styles */
        .notifications {
            position: fixed;
            top: 20px;
            right: 10px;
            left: 10px;
            margin: auto;
            width: auto;
            max-width: 90%;
        }
        .notifications .toast {
            width: 100%;
            max-width: 400px;
            position: relative;
            overflow: hidden;
            list-style: none;
            border-radius: 4px;
            padding: 16px 17px;
            margin-bottom: 10px;
            background: #f8d7da; /* Light error background */
            justify-content: space-between;
            animation: show_toast 0.3s ease forwards;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        @keyframes show_toast {
            0% {
                transform: translateX(100%);
            }
            40% {
                transform: translateX(-5%);
            }
            80% {
                transform: translateX(0%);
            }
            100% {
                transform: translateX(-10px);
            }
        }
        .toast::before {
            position: absolute;
            content: "";
            height: 3px;
            width: 100%;
            bottom: 0px;
            left: 0px;
            animation: progress 3s linear forwards;
            background: #c82333; /* Error color */
        }
        @keyframes progress {
            100% {
                width: 0%;
            }
        }
        
#progressBarContainer {
    width: 60%; /* Smaller width for the container */
    background-color: #f3f3f3;
    border-radius: 10px; /* Rounded corners */
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2); /* Slight shadow inside */
    margin: 20px auto; /* Center the container horizontally */
    height: 20px; /* Height of the progress bar container */
    overflow: hidden; /* Prevents overflow of the progress bar */
    display: none; /* Hidden by default */
}

#progressBar {
    width: 0%; /* Starting width */
    height: 100%; /* Full height */
    background-color: #4caf50; /* Bar color */
    border-radius: 10px; /* Rounded corners */
    transition: width 0.4s ease; /* Smooth transition */
}

.spinner-container {
    display: none;
    justify-content: center;
    align-items: center;
    margin-bottom: 5px; /* Reduced distance to progress bar */
}

.spinner-container span {
    margin-right: 5px; /* Reduced space between text and spinner */
    font-size: 14px; /* Smaller text size for "Loading" */
    color: #333; /* Optional: text color */
}

.spinner {
    border: 3px solid rgba(0, 0, 0, 0.1); /* Lighter border */
    border-top: 3px solid #28a745; /* Green color to match buttons */
    border-radius: 50%;
    width: 20px; /* Smaller spinner size */
    height: 20px; /* Smaller spinner size */
    animation: spin 0.8s linear infinite; /* Slightly faster spin */
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}




        .toast .column i {
            font-size: 1.75rem;
            color: #c82333; /* Error color */
        }
        .toast .column span {
            font-size: 1.07rem;
            margin-left: 12px;
            color: #721c24; /* Dark text color */
            word-wrap: break-word;
        }
        
        .leaflet-control-attribution {
            display: none;
        }
        
        @media (max-width: 768px) {
            .search-container {
                flex-direction: column;
                padding: 10px;
            }
            .search-container input, .search-container button {
                width: 100%;
                margin-bottom: 10px;
            }
            #map {
                height: calc(100vh - 120px); /* Adjust height for mobile screens */
            }
        }
        /* Prevent screen zoom and scroll on mobile devices */
        html, body {
            touch-action: none;
        }
    </style>
</head>
<body>

    <h1>Event Finder BETA</h1>
    

<div class="spinner-container" id="spinnerContainer">
    <span>Loading</span>
    <div class="spinner"></div>
</div>


    <div id="progressBarContainer">
    <div id="progressBar"></div>
    </div>

    

    <div class="toggle-container">
        <button id="mapButton" class="active" onclick="toggleView('map')">Map View</button>
        <button id="listButton" onclick="toggleView('list')">List View</button>
    </div>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Describe in one word..." maxlength="20" onkeypress="checkEnter(event)">
        <button onclick="fetchAndFilterEvents()">Search</button>
    </div>

    <div id="map" class="active"></div>
    <div id="results" class="result-container"></div>

    <div class="notifications" id="notifications"></div>

    <!-- Leaflet JS for the map -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <!-- MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
        // Initialize the map with specified options
        const map = L.map('map', {
            center: [0, 0], // Center the map on the equator and prime meridian
            zoom: 2, // Set an initial zoom level
            zoomControl: false,
            maxBounds: [
                [-90, -180], // Southwest corner of the map
                [90, 180]    // Northeast corner of the map
            ],
            maxBoundsViscosity: 1.0, // Keeps the map within these bounds
            minZoom: 2, // Prevents zooming out too far to see the entire world multiple times
            worldCopyJump: false // Prevents world wrapping
        });

        // User Location Icon
        var userLocationIcon = L.icon({
            iconUrl: 'https://github.com/ALD-Models/Testing/blob/main/Icons/Me.png?raw=true', // Original user location icon URL
            iconSize: [34, 34], // Adjust the size as needed
            iconAnchor: [15, 30], // Position the icon correctly
            popupAnchor: [0, -28] // Position the popup above the icon
        });

        // Event Marker Icon
        var eventMarkerIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/ALD-Models/Testing/main/Icons/Chat.png', // Updated event icon URL
            iconSize: [34, 34], // Adjust the size as needed
            iconAnchor: [15, 30], // Position the icon correctly
            popupAnchor: [0, -28] // Position the popup above the icon
        });

        // Add Carto tiles (Voyager)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png', {
            maxZoom: 20,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        }).addTo(map);
        
        

        // MarkerCluster Group
        const markersLayer = L.markerClusterGroup();
        map.addLayer(markersLayer);

        // Get user location
        navigator.geolocation.getCurrentPosition(async (position) => {
            const userCoords = [position.coords.latitude, position.coords.longitude];
            L.marker(userCoords, { icon: userLocationIcon }).addTo(map).bindPopup("You are here").openPopup();
            await zoomToUserCountry(userCoords); // Zoom to user's country
        }, () => {
            alert("Could not get your location.");
        });

        // Function to zoom to the user's country
        async function zoomToUserCountry(userCoords) {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${userCoords[0]}&lon=${userCoords[1]}&format=json`);
            const data = await response.json();
            const country = data.address.country;

            // Set map view to the country level (adjust zoom level as needed)
            if (country) {
                map.setView(userCoords, 5); // Change zoom level as necessary for country view
            }
        }
        
const synonymDictionary = {
    // Natural Environments
    'seaside': 'beach',
    'beach': 'beach',
    'cliff': 'rock',
    'mountain': 'hill',
    'hill': 'hill',
    'valley': 'lowland',
    'forest': 'woodland',
    'jungle': 'forest',
    'desert': 'arid region',
    'swamp': 'wetland',
    'marsh': 'wetland',
    'canyon': 'gorge',
    'river': 'waterway',
    'lake': 'waterbody',
    'ocean': 'sea',
    'bay': 'harbor',
    'island': 'landmass',
    'volcano': 'mountain',
    'prairie': 'grassland',
    'tundra': 'cold land',
    'plateau': 'highland',
    'glen': 'valley',

};


async function fetchAndFilterEvents() {
    const query = document.getElementById("searchInput").value.trim().toLowerCase();
    const translatedWord = synonymDictionary[query] || query;

    // Show spinner with "Loading" text
    const spinnerContainer = document.getElementById("spinnerContainer");
    spinnerContainer.style.display = 'flex'; // Show spinner

    const response = await fetch("https://raw.githubusercontent.com/ALD-Models/Testing/refs/heads/main/parkruns.json");
    const data = await response.json();
    const events = data.events.features;

    // Clear previous markers and results
    markersLayer.clearLayers();
    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "";

    // Initialize and reset progress bar
    const progressBarContainer = document.getElementById("progressBarContainer");
    const progressBar = document.getElementById("progressBar");

    progressBar.style.width = "0%"; // Reset the progress bar
    progressBarContainer.style.display = "block"; // Show the progress bar

    // Create an array of fetch promises
    const fetchPromises = events.map(async (event, i) => {
        const coords = event.geometry.coordinates;
        const features = await fetchGeographicalFeatures(coords);

        // Check if any feature matches the query
        const isFeatureNearby = features.some(feature => feature.includes(translatedWord));

        if (isFeatureNearby) {
            // Add marker and event to results
            const marker = L.marker([coords[1], coords[0]], { icon: eventMarkerIcon });
            marker.bindPopup(`<b>${event.properties.EventLongName}</b><br>${event.properties.EventLocation}`);
            markersLayer.addLayer(marker);

            // Add event to results list
            const resultItem = document.createElement("div");
            resultItem.innerHTML = `<b>${event.properties.EventLongName}</b><br>${event.properties.EventLocation}`;
            resultItem.onclick = () => {
                map.setView([coords[1], coords[0]], 13);
            };
            resultsDiv.appendChild(resultItem);
        }

        // Update progress bar based on completion
        const progress = ((i + 1) / events.length) * 100;
        progressBar.style.width = `${progress}%`;
    });

    // Wait for all fetch promises to complete
    await Promise.all(fetchPromises);

    // Optionally, hide progress bar after a short delay
    progressBar.style.width = "100%";
    setTimeout(() => {
        progressBarContainer.style.display = "none"; // Hide the progress bar
    }, 500);

    // Hide the spinner after all events have been fetched
    spinnerContainer.style.display = 'none'; // Hide spinner

    const userCoords = await getUserLocation();
    await zoomToUserCountry(userCoords);
}





////here
        
        


        // Get user's current location for zooming
        async function getUserLocation() {
            return new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition((position) => {
                    resolve([position.coords.latitude, position.coords.longitude]);
                });
            });
        }

        // Show "Nothing to show" notification
        function showNoResultsNotification() {
    const notificationsDiv = document.getElementById("notifications");
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.innerHTML = `<div class="column"><i class="fas fa-exclamation-circle"></i><span>No results found</span></div>`;
    notificationsDiv.appendChild(toast);
    setTimeout(() => { notificationsDiv.removeChild(toast); }, 3000); // Auto-remove
}


        // Toggle between map and list view
        function toggleView(view) {
            const mapButton = document.getElementById('mapButton');
            const listButton = document.getElementById('listButton');
            const mapDiv = document.getElementById('map');
            const resultsDiv = document.getElementById('results');

            if (view === 'map') {
                mapButton.classList.add('active');
                listButton.classList.remove('active');
                mapDiv.classList.add('active');
                resultsDiv.classList.remove('active');
            } else {
                listButton.classList.add('active');
                mapButton.classList.remove('active');
                resultsDiv.classList.add('active');
                mapDiv.classList.remove('active');
            }
        }
        
        async function fetchGeographicalFeatures(coords) {
    const [lon, lat] = coords;
    const radius = 350; 

    const query = `
        [out:json];
        (
            node["natural"](around:${radius},${lat},${lon});
            way["natural"](around:${radius},${lat},${lon});
            relation["natural"](around:${radius},${lat},${lon});
        );
        out body;`;

    const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
    const response = await fetch(url);
    const data = await response.json();

    return data.elements.map(el => el.tags && el.tags.natural);
}

        

// Select buttons and text elements you want to disable long press on
const buttons = document.querySelectorAll('button, .disable-long-press'); // Add your specific classes or IDs
buttons.forEach(disableLongPress);


        // Check if the Enter key is pressed
        function checkEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission
                fetchAndFilterEvents(); // Trigger search
            }
        }
    </script>
    
</body>
</html>
